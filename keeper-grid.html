<!DOCTYPE html>

<html lang="it">
<head>
    <meta http-equiv="CONTENT-TYPE" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name = "theme-color" content="#000000">
    <link rel="stylesheet" href="styles/style.css"/>
    <title>FantaStats</title>
</head>
<style>
    .grid{
        overflow-y: hidden;
    }
    .days{
        display: flex;
        gap:5px;
        margin-bottom: 10px;
    }
    .title{
        align-content: top;
        text-align: center;
    }
    .day, .logo{
        width: 32px;
        min-width: 32px;
        max-width: 32px;
        aspect-ratio: 1;
        max-height: 32px;
        background-color: var(--BlueLightMode);
        color: white;
        border-radius: 8px;
        align-content: center;
        font-size: 16px;
        text-align: center;
    }
    .keepers{
        display: flex;
    }
    .selection{
        display: flex;
        flex-direction: column;
        gap: 10px;
        width: 169px;
        height: 121px;
    }
    select, .title{
        width: 169px;
        min-width: 169px;
        height: 32px;
        min-height: 32px;
        border-radius: 8px;
        font-size: 100%;
        font-weight: 200;
    }
    .matches{
        display: flex;
        flex-direction: column;
        gap: 10px
    }
    .match0, .match1, .match2{
        height: 32px;
        width: auto;
        gap: 5px;
        display: flex;
        margin-left: 5px;
    }
    .logo{
        display: flex;
    }
    img{
        margin-block: auto;
        margin-inline: auto;
    }
    .result{
        margin-block: 5vh;
        margin-inline: auto;
        width: 80%;
        display: flex;
        justify-content: space-around;
        border-radius: 20px;
        transition: transform 0.2s;
        padding-block: 2vh;
        padding-inline: 1vw;
    }
    .result:hover{
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .value{
        width: auto;
    }
    .summary{
        display: flex;
        justify-content: space-between;
        gap: 2vw
    }
    .easy, .medium, .hard{
        display: flex;
        flex-direction: column;
    }
    .team{
        background-color: white;
        color: black;
        border: solid 1px gray;
    }
    .p92{
        color: black;
        background-color: var(--BlueLightMode);
        border-color: var(--BlueLightMode);
    }
    .p89{
        border-color: var(--BlueLightMode);
        color: var(--BlueLightMode)
    }
    .days{
        margin-inline: auto;
    }
    .landscape-teams{
        width: 814px;
    }
    .portrait-teams{
        display: flex;
        flex-direction: column;
        gap:5px;
    }
    @media(orientation: portrait){
        .result{
            width: 80%;
            justify-content: space-between;
            flex-direction: column;
        }
        .value, .days{
            margin-inline: auto;
        }
        .value{
            margin-bottom: 2vh;
        }
        .summary{
            gap: 2vw
        }
        .text{
            text-align: center;
        }
    }
    @media(prefers-color-scheme: dark){
        .day{
            background-color: var(--BlueDarkMode);
        }
        .result:hover{
            transform: translateY(-2px);
            box-shadow: 0 4px 8px white;
        }
        .result{
            color: white
        }
        .keeper{
            color: white;
        }
        option{
            color:white;
            background-color: black;
        }
        .team{
            background-color: black;
            border: solid 1px gray;
            color: white
        }
        .p92{
            color: white;
            background-color: var(--BlueDarkMode);
            border-color: var(--BlueDarkMode);
        }
        .p89{
            border-color: var(--BlueDarkMode);
            color: var(--BlueDarkMode)
        }
    }
</style>
<body>
    <header>
        <h1>
            <a href="index">
                <span class="f">F</span><span>antaStats</span>
            </a>
        </h1>
        <div class="menu">
            <button class="user-teams" onclick="window.location.href='teams.html'"></button>
            <div class="search">
                <button class="search-icon"></button>
                <div class="search-box hidden">
                    <input type="text" id="searchInput" placeholder="Cerca un giocatore...">
                    <div id="searchResults" class="search-results"></div>
                </div>
            </div>
        </div>
    </header>
    <hr>
    <h2>Abbinamento Portieri</h2>
    <div class="grid">
        <div class="days">
            <div class="title">Abbinamento</div>
        </div>
        <div class="keepers">
            <div class="selection">
                <select class="keeper select0">

                </select>
                <select class="keeper select1">

                </select>
                <select class="keeper select2">

                </select>
            </div>
            <div class="matches">
                <div class="match0"></div>
                <div class="match1"></div>
                <div class="match2"></div>
            </div>
        </div>
    </div>
    <div class="result">
        <div class="value">0/100</div>
        <div class="summary">
            <div class="easy">
                <div class="days">0</div>
                <div class="text">Giornate Facili</div>
            </div>
            <div class="medium">
                <div class="days">0</div>
                <div class="text">Giornate Medie</div>
            </div>
            <div class="hard">
                <div class="days">0</div>
                <div class="text">Giornate Difficili</div>
            </div>
        </div>
    </div>

    <div class="grid keepers-grid">
        <div class="days landscape-teams">
            
        </div>
    </div>

</body>
<script src="script.js"></script>  
<script>
    let gfgs = [];
    let allTeams = [];
    let difficolta = Array(38).fill('H');

    document.addEventListener("DOMContentLoaded", () => firstLoad());
    async function firstLoad(){
        try {
            if (allMatches.length === 0) {
                const response = await fetch('calendario.json');
                allMatches = await response.json();
                const days = document.querySelector('.days');
                for(let i=0; i<38; i++){
                    days.innerHTML += `
                        <div class="day">${i+1}</div>
                    `;
                }
            }
            if (allTeams.length === 0) {
                const response = await fetch('GFGS.json');
                const _gfgs = await response.json();
                gfgs = _gfgs
                allTeams = gfgs.map(x => x.name);
                allTeams.sort((a, b) => a.localeCompare(b));
                console.log(document.querySelectorAll('.keeper'));
                document.querySelectorAll('.keeper').forEach(select => {
                    select.innerHTML += `<option value="seleziona" selected>Seleziona</option>`
                    select.addEventListener('change', function(e) {
                        console.log('Classe del select:', this.className);
                        modifyKeeper(this.className);
                    });
                });
                document.querySelectorAll('.keeper').forEach(select => {
                    select.innerHTML += allTeams.map(team => `
                        <option value="${team}">${team}</option>
                    `).join('');
                    select.addEventListener('change', function(e) {
                        console.log('Classe del select:', this.className);
                        modifyKeeper(this.className);
                    });
                });
            }

            const landscape = document.querySelector('.landscape-teams');
            gfgs.sort((a, b) => a.name.localeCompare(b.name));
            landscape.innerHTML += `<div class="day team" style="color: transparent; border-color: transparent; background-color: transparent"></div>`;
            for(let i=0; i<gfgs.length; i++){
                landscape.innerHTML += `
                    <div class="day team" style="background-image: url('images/${gfgs[i].id}.png'); background-size: cover"></div>
                `;
            }
            const grid = document.querySelector('.keepers-grid');
            for(let i=0; i<gfgs.length; i++){
                const team = document.createElement('div');
                team.classList += 'landscape-teams';
                team.classList += ' days';
                team.innerHTML += `
                    <div class="day team" style="background-image: url('images/${gfgs[i].id}.png'); background-size: cover"></div>
                `;
                for(let j=0; j<gfgs.length; j++){
                    const value = calcKeepers([gfgs[i].name, gfgs[j].name]);
                    team.innerHTML += `
                        <div class="day team ${(value>=89)? (value>=92)? "p92" : "p89" : ""}">${value}</div>
                    `;
                }
                grid.appendChild(team);
            }
        } catch (error) {
            console.error('Errore nel caricamento delle partite:', error);
            container.innerHTML = '<div class="error">Errore nel caricamento delle partite. Verifica che il file calendario.json sia presente e corretto.</div>';
        }
    }

    let keepers = [
        'seleziona',
        'seleziona',
        'seleziona'
    ];
    async function modifyKeeper(className){
        console.log(keepers);
        className = className.replace('keeper ', '');
        let value = document.querySelector(`.${className}`).value;
        className = className.replace('select', '');
        parseInt(className);
        keepers[className] = value;
        let matchDiv = document.querySelector(`.match${className}`);
        matchDiv.innerHTML = '';
        let day = 0;
        for(let j=0; j<allMatches.length; j++){        
            if(keepers[className] == allMatches[j].home.name){
                const defQual = gfgs.filter(x => x.id == allMatches[j].away.id).map(x => x.attackQuality);
                matchDiv.innerHTML += `<div class="logo" style="background-color: ${(defQual <= 3)?'green':(defQual < 4.5)?'orange':'red'}"><img src="images/${allMatches[j].away.id}.png" height="23" width="23"></div>`     
            }
            else if(keepers[className] == allMatches[j].away.name){
                const defQual = gfgs.filter(x => x.id == allMatches[j].home.id).map(x => x.attackQuality)
                matchDiv.innerHTML += `<div class="logo" style="background-color: ${(defQual <= 3)?'green':(defQual < 4.5)?'orange':'red'}"><img src="images/${allMatches[j].home.id}.png" height="23" width="23"></div>`
            
            }
        }
        await recalc();
        let sum = difficolta.reduce((_sum, x) => _sum + ((x == 'E') ? 1 : (x == 'M') ? 0.5 : 0), 0)
        console.log(sum);
        let difPerc = 100 * sum / 38;
        console.log(difPerc);
        document.querySelector('.value').innerHTML = `${Math.round(difPerc)}/100`;
        document.querySelector('.easy .days').innerHTML = difficolta.filter(x => x === 'E').length;
        document.querySelector('.medium .days').innerHTML = difficolta.filter(x => x === 'M').length;
        document.querySelector('.hard .days').innerHTML = difficolta.filter(x => x === 'H').length;
    }
    function recalc(){
        difficolta = Array(38).fill('H');
        console.log(keepers);
        for(let i=0; i<allMatches.length; i++){
            if(keepers.includes(allMatches[i].home.name)){
                const defQual = gfgs.filter(x => x.id == allMatches[i].away.id).map(x => x.attackQuality);
                if(difficolta[parseInt(i/10)] == 'H' && defQual <= 4)
                    difficolta[parseInt(i/10)] = (defQual <= 3) ? 'E' : 'M';
                if(difficolta[parseInt(i/10)] == 'M' && defQual <= 3)
                    difficolta[parseInt(i/10)] = 'E';                    
            }
 
            if(keepers.includes(allMatches[i].away.name)){
                const defQual = gfgs.filter(x => x.id == allMatches[i].home.id).map(x => x.attackQuality);
                if(difficolta[parseInt(i/10)] == 'H' && defQual <= 4)
                    difficolta[parseInt(i/10)] = (defQual <= 3) ? 'E' : 'M';
                if(difficolta[parseInt(i/10)] == 'M' && defQual <= 3)
                    difficolta[parseInt(i/10)] = 'E';                    
            }
        }
    }

</script>
</html>
